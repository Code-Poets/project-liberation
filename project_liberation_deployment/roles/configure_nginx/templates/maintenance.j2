limit_req_zone $binary_remote_addr zone=ip_req_limit:10m rate={{ nginx.limit_of_requests_per_second }}r/s;
limit_conn_zone $binary_remote_addr zone=ip_connection_limit:10m;

# Disable sending the nginx version in error pages and server header
server_tokens off;

# Don't allow the browser to render the page inside an frame
add_header X-Frame-Options SAMEORIGIN;

# Add X-Content-Type-Options header that disables concent-type sniffing on some browsers
add_header X-Content-Type-Options nosniff;

# Add X-XSS-Protection header that enables the Cross-site scripting filter in the browsers
add_header X-XSS-Protection "1; mode=block";

# Restricting access based on country
geoip_country /usr/share/GeoIP/GeoIP.dat;
map $geoip_country_code $country_access {
    "IN"    1;
    default 0;
}

server {
    server_name codepoets.it www.codepoets.it;

    if ($country_access = '1') {
        return 403;
    }

    error_page 503 /maintenance.html;

    location = /maintenance.html {
       root /var/www/html/;
       internal;
    }

    location = /favicon.ico {
        alias {{ nginx_static_files_dir }}/favicon.ico;
    }

    location / {
        limit_req  zone=ip_req_limit   burst={{ nginx.number_of_requests_stored_in_queue }} nodelay;
        limit_conn ip_connection_limit {{ nginx.number_of_open_connections_per_client }};
        return 503;
    }

    location /nginx-static/ {
        expires     1y;
        add_header  Cache-Control "public";

        # Enable HSTS header
        add_header  Strict-Transport-Security "max-age=31536000";

        alias {{ nginx_static_files_dir }}/;
    }

	listen [::]:443 ssl ipv6only=on;
	listen 443 ssl;

	ssl_certificate {{ certificates_dir }}/certificate-fullchain.pem;
	ssl_certificate_key {{ certificates_dir }}/certificate-privkey.pem;

	ssl_session_cache shared:le_nginx_SSL:1m;
	ssl_session_timeout 1440m;

	ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
	ssl_prefer_server_ciphers on;

	ssl_ciphers "ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA:ECDHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:DHE-RSA-AES256-SHA:ECDHE-ECDSA-DES-CBC3-SHA:ECDHE-RSA-DES-CBC3-SHA:EDH-RSA-DES-CBC3-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:DES-CBC3-SHA:!DSS";
	ssl_dhparam {{ certificates_dir }}/ssl-dhparams.pem;

    # Enable HSTS header
    add_header Strict-Transport-Security "max-age=31536000";

}

server {
    if ($country_access = '1') {
        return 403;
    }
    if ($host = codepoets.it) {
        return 301 https://codepoets.it$request_uri;
    }
    if ($host = www.codepoets.it) {
        return 301 https://codepoets.it$request_uri;
    }


    listen           80 default_server;
    listen      [::]:80 default_server;
    server_name codepoets.it www.codepoets.it;

    client_body_timeout   {{ nginx.client_body_timeout }};
    client_header_timeout {{ nginx.client_header_timeout }};
    return 404;

}
